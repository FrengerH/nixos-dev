{{- if .Values.ssh.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "nixos-server.fullname" . }}-ssh-config
  labels:
    {{- include "nixos-server.labels" . | nindent 4 }}
data:
  flake.nix: |
    {
      description = "NixOS Server SSH Configuration";

      inputs = {
        nixpkgs.url = "github:NixOS/nixpkgs/nixos-unstable";
      };

      outputs = { self, nixpkgs }:
        let
          system = "x86_64-linux";
          pkgs = nixpkgs.legacyPackages.${system};
        in {
          packages.${system} = {
            ssh-server = pkgs.writeShellApplication {
              name = "start-ssh";
              runtimeInputs = with pkgs; [ openssh coreutils ];
              text = ''
                set -e

                PORT=${SSH_PORT:-22}
                USERNAME=${SSH_USERNAME:-nix}
                PASSWORD_AUTH=${SSH_PASSWORD_AUTH:-"no"}

                mkdir -p /run/sshd
                mkdir -p /etc/ssh

                cat > /etc/ssh/sshd_config << EOF
                Port $PORT
                PermitRootLogin no
                PasswordAuthentication $PASSWORD_AUTH
                PubkeyAuthentication yes
                UsePAM no
                AllowUsers $USERNAME
                EOF

                if [ -n "$SSH_AUTHORIZED_KEYS" ]; then
                  mkdir -p "/home/$USERNAME/.ssh"
                  echo "$SSH_AUTHORIZED_KEYS" | tr '\n' '\n' > "/home/$USERNAME/.ssh/authorized_keys"
                  chmod 700 "/home/$USERNAME/.ssh"
                  chmod 600 "/home/$USERNAME/.ssh/authorized_keys"
                fi

                echo "SSH server starting on port $PORT..."
                exec sshd -D -f /etc/ssh/sshd_config
              '';
            };
          };

          defaultPackage.${system} = self.packages.${system}.ssh-server;
        };
    }
  start-ssh.sh: |
    #!/bin/sh
    set -e

    export SSH_PORT={{ .Values.ssh.port }}
    export SSH_USERNAME={{ .Values.ssh.username }}
    {{- if .Values.ssh.password }}
    export SSH_PASSWORD_AUTH="yes"
    {{- else }}
    export SSH_PASSWORD_AUTH="no"
    {{- end }}
    export SSH_AUTHORIZED_KEYS="{{- range .Values.ssh.authorizedKeys }}{{ . }}{{ end }}"

    cd /opt/ssh-flake
    exec nix run
{{- end }}